<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8"/>
    <title></title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"
            integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T"
            crossorigin="anonymous"></script>

    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css"
          integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

    <script src="../node_modules/web3/dist/web3-light.js"></script>
    <script src="../node_modules/keccak/index.js"></script>

    <script>
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }
        web3.eth.defaultAccount = web3.eth.accounts[0];
        console.log(web3.eth.accounts)

        const abi = JSON.parse('[{"constant":true,"inputs":[],"name":"getBoxes","outputs":[{"name":"","type":"address[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"box","type":"address"}],"name":"getLastState","outputs":[{"name":"ok","type":"bool"},{"name":"opened","type":"bool"},{"name":"location","type":"string"},{"name":"error","type":"string"},{"name":"timestamp","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"box","type":"address"}],"name":"ifCanBeOpened","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"box","type":"address"},{"name":"receiver","type":"address"}],"name":"setReceiver","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"box","type":"address"},{"name":"secret","type":"string"}],"name":"open","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"box","type":"address"}],"name":"getStatesCount","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"ok","type":"bool"},{"name":"opened","type":"bool"},{"name":"location","type":"string"},{"name":"error","type":"string"}],"name":"state","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"box","type":"address"},{"name":"secret","type":"string"}],"name":"setSecret","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"box","type":"address"},{"name":"index","type":"uint256"}],"name":"getState","outputs":[{"name":"ok","type":"bool"},{"name":"opened","type":"bool"},{"name":"location","type":"string"},{"name":"error","type":"string"},{"name":"timestamp","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"box","type":"address"}],"name":"addBox","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"box","type":"address"}],"name":"close","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]');

        const YashchexContract = web3.eth.contract(abi);

        const yashchex = YashchexContract.at('0xbc4718d51b040351bd52214f60395f4e002ed4f6');
        console.log(yashchex);

        function getBoxes() {
            console.log(`getBoxes()`)
            return new Promise(resolve => {
                yashchex.getBoxes((error, boxes) => {
                    console.log('boxes:', boxes)
                    resolve(boxes);
                })
            })
        }

        function addBox(box) {
            console.log(`addBox(box: ${box})`)
            return new Promise(resolve => {
                // yashchex.addBox(box)
                // resolve(true)
                yashchex.addBox(box, (error, res) => {
                    console.log('addBox success:', error == null, error)
                    resolve(res);
                })
            })
        }

        function setReceiver(box, receiver) {
            console.log(`setReceiver(box: ${box}, receiver: ${receiver})`)
            return new Promise(resolve => {
                yashchex.setReceiver(box, receiver, (error, res) => {
                    console.log('setReceiver success:', error == null, error)
                    yashchex.close(box, (error, res) => {
                        console.log('close success:', error == null, error)
                        resolve(res);
                    })
                })
            })
        }

        function setSecret(box, secret) {
            console.log(`setSecret(box: ${box}, secret: ${secret})`)
            return new Promise(resolve => {
                // const hash = kessak('keccak256').update(secret).digest('hex');
                yashchex.setSecret(box, secret, (error, res) => {
                    console.log('setReceiver success:', error == null, error)
                    resolve(res);
                })
            })
        }

        function open(box, secret) {
            console.log(`open(box: ${box}, secret: ${secret})`)
            return new Promise(resolve => {
                yashchex.open(box, secret, (error, res) => {
                    console.log('open success:', error == null, error)
                    resolve(res);
                })
            })
        }

        function onClick() {
            const box = '0x123f681646d4a755815f9cb19e1acc8565a0c2ac'
            const receiver = '0x1C42B66fC4fD2dfF7182d42678729788f20dc8C8'
            getBoxes().then(boxes => {
                console.log('successfully got boxes!')
            })
            setReceiver(box, receiver).then(res2 => {
                console.log('successfully set receiver!')
                setSecret(box, 'secret').then(res3 => {
                    console.log('successfully set secret!')
                })
            })
            // addBox(box)
            //     .then(res1 => {
            //         getBoxes().then(boxes => {
            //             console.log('successfully got boxes!')
            //         })
            //         setReceiver(box, receiver).then(res2 => {
            //             console.log('successfully set receiver!')
            //             setSecret(box, 'secret').then(res3 => {
            //                 console.log('successfully set secret!')
            //             })
            //         })
            //
            //     })

        }
    </script>
</head>
<body onload="init()">
<script>
    function init() {
        renderBoxes()
    }

    FontAwesomeConfig = {searchPseudoElements: true};
    var box = "";

    function hideSender() {
        var s = document.getElementById("sender_div");
        if (s.style.display === "none") {
            s.style.display = "block";
        } else {
            s.style.display = "none";
        }

        var r = document.getElementById("receiver_div");
        if (r.style.display === "none") {
            r.style.display = "block";
        } else {
            r.style.display = "none";
        }
    }

    function setBox(box) {
        const form = (box) =>
            `<form id="modalForm">
                            <h3>Ящик</h3>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="sender_box_span">Коробка</span>
                                </div>
                                <input type="text" readonly class="form-control" id="sender_box" onloadstart="getBox()"
                                       aria-describedby="basic-addon3"
                                       value="${box}">
                            </div>

                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="sender_receiver_span">Получатель</span>
                                </div>
                                <input type="text" class="form-control" id="sender_receiver"
                                       aria-describedby="basic-addon3">
                            </div>

                            <button type="button" class="btn btn-primary btn-warning btn-lg" data-toggle="modal" data-target="#modalSendBox" onclick="sendBox('${box}', jQuery('#sender_receiver').val())">
                                <i class="fas fa-parachute-box"></i>
                                Отправить
                            </button>
                        </form>`
        jQuery('#sender-from-container').html(form(box))
    }

    function sendBox(box, receiver) {
        setReceiver(box, receiver)
    }

    function selectBox(box) {
        jQuery('.box-container').css('background-color', 'white')
        jQuery(`#box-${box}`).css('background-color', 'rgba(255,193,7, 0.2)')
        renderStates(box)
    }

    function renderBoxes() {
        const boxes = ['0xca30e63200a0fe3182dc61fc5605efc41456f32', '0x493c4afb73b490e988650b9758e7736c72af748f']
        const renderBox = (box, index) =>
            `<div class="box-container col-sm-4">
                <form id="box-${box}" onclick="selectBox('${box}')">
                    <h3>Ящик ${index+1}</span></h3>
                    <input type="text" readonly class="form-control-plaintext" id="address_box_1"
                           value="${box}">
                    <button type="button" class="btn btn-primary btn-warning btn-lg" data-toggle="modal"
                            data-target="#modalSendBox"
                            onclick="setBox('0xca30e63200a0fe3182dc61fc5605efc41456f32')"><i
                            class="fas fa-parachute-box"></i> Отправить
                    </button>
                </form>
            </div>`
        jQuery('#boxes-container').html(boxes.map(renderBox))
    }

</script>

<div class="row well well-lg">
    <div class="col-md-6 col-md-offset-3">
        <input type="checkbox" data-toggle="toggle" data-size="large" data-offstyle="warning"
               data-onstyle="info" data-off="Отправитель" data-on="Получатель" aria-expanded="true"
               onchange="hideSender()">
    </div>
</div>
<div class="jumbotron text-center">
    <h1>Yashchex</h1>
    <p>Первое решение для криптографической защиты ваших грузов</p>
</div>

<div id="sender_div" style="display: block">
    <div class="container">
        <div class="row" id="boxes-container">

        </div>

        <div class="modal fade" id="modalSendBox" tabindex="-1" role="dialog" onload="getBox()">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body" id="sender-from-container">

                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="box_container"></div>
</div>

<div id="receiver_div" style="display: none">
    <div class="container">
        <form>
            <h3>Ящик</h3>

            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="receiver_box_span">Коробка</span>
                </div>
                <input type="text" class="form-control" id="receiver_box" aria-describedby="basic-addon3">
            </div>

            <button type="button" data-toggle="modal" data-target="#modalReceiveSecret" class="btn btn-primary btn-info btn-lg"><i class="fas fa-user-check"></i>
                Задать секрет
            </button>

            <button type="button" data-toggle="modal" data-target="#modalReceiveOpen" class="btn btn-primary btn-info btn-lg"><i class="fas fa-user-check"></i>
                Открыть ящик
            </button>
        </form>

        <div class="modal fade" id="modalReceiveSecret" tabindex="-1" role="dialog" onload="getBox()">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <form id="modalForm2" onchange="getBox()">

                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="sender_receiver_span2">Секрет</span>
                                </div>
                                <input type="text" class="form-control" id="sender_receiver2"
                                       aria-describedby="basic-addon3">
                            </div>

                            <button type="button" data-toggle="modal" data-target="#modalReceiveSecret"
                                    class="btn btn-primary btn-warning btn-lg" onclick="setSecret(jQuery('#receiver_box').val(), jQuery('#sender_receiver2').val())">
                                Задать
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modalReceiveOpen" tabindex="-1" role="dialog" onload="getBox()">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-body">
                        <form id="modalForm3" onchange="getBox()">

                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="sender_receiver_span3">Секрет</span>
                                </div>
                                <input type="text" class="form-control" id="sender_receiver3"
                                       aria-describedby="basic-addon3">
                            </div>

                            <button type="button" data-toggle="modal" data-target="#modalReceiveOpen"
                                    class="btn btn-primary btn-warning btn-lg">
                                Открыть
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button onclick="onClick()">Boxes</button>
</div>

<script>

    function getStates() {
        return Promise.resolve([
            {ok: true, opened: true, location: '123,321', error: 0, timestamp: 123456},
            {ok: true, opened: false, location: '654,876', error: 0, timestamp: 123457},
            {ok: true, opened: true, location: '934,635', error: 0, timestamp: 123458},
            {ok: true, opened: true, location: '549,384', error: 0, timestamp: 123459}
        ])
    }

    function renderStates(box) {
        getStates().then(states => {
            const rows = states.map(state => renderState(state))
            const table =
                `<div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Состояние</th>
                                <th>Открыт</th>
                                <th>Локация</th>
                                <th>Ошибка</th>
                                <th>Время</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                </div>`
            jQuery('#box_container').html(table)
        })
    }

    function renderState(state) {
        return (
            `<tr style="background-color: ${state.ok ? 'lightgreen' : 'pink'}">
                <td>${state.ok ? 'OK' : 'DAMAGED!'}</td>
                <td>${state.opened ? 'Открыт' : 'Закрыт'}</td>
                <td>${state.location}</td>
                <td>${state.error}</td>
                <td>${state.timestamp ? new Date(state.timestamp).toString() : ''}</td>
            </tr>`
        )
    }

</script>

</body>
</html>